<script>
    /**
     * Scripts_Print_Map
     * Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏≤‡∏£‡∏ì‡πå (A4 Landscape)
     * Update: FIX Ticket overlapping (Force hide ticket areas)
     */

    function openMapPrintPreview() {
        if (!stallsData || stallsData.length === 0) {
            showAlert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏±‡∏á‡∏ï‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö", "‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", true);
            return;
        }

        // 1. Force Hide Ticket Areas via JS (Safety Check)
        const ticketArea = document.getElementById('ticket-area');
        if (ticketArea) ticketArea.style.display = 'none';
        
        const monthlyArea = document.getElementById('monthly-ticket-area');
        if (monthlyArea) monthlyArea.style.display = 'none';

        const printHtml = generateMapPrintHtml();
        const printArea = getOrCreatePrintArea('report-print-area');
        
        const controls = `
            <div class="no-print" style="
                position: sticky; top: 0; left: 0; width: 100%; 
                background: #4A3B32; color: #FDF5E6; padding: 12px 20px; 
                display: flex; justify-content: space-between; align-items: center;
                box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 10001;
                font-family: 'Sarabun', sans-serif;
            ">
                <div style="font-weight: bold; font-size: 16px;">
                    <i class="fa-solid fa-map"></i> ‡∏ú‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏≤‡∏£‡∏ì‡πå (Map Report)
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="window.print()" style="
                        background: #2E7D32; color: white; border: 1px solid #1B5E20; 
                        padding: 6px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;
                        display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    ">
                        <i class="fa-solid fa-print"></i> ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
                    </button>
                    <button onclick="closeMapPrint()" style="
                        background: #C62828; color: white; border: 1px solid #B71C1C; 
                        padding: 6px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;
                        display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    ">
                        <i class="fa-solid fa-times"></i> ‡∏õ‡∏¥‡∏î
                    </button>
                </div>
            </div>
            <div style="background: white; padding: 0; min-height: 100vh; overflow: auto; display: flex; justify-content: center;">
                ${printHtml}
            </div>
        `;
        
        printArea.innerHTML = controls;
        printArea.style.display = 'block';
    }

    function closeMapPrint() {
        const area = document.getElementById('report-print-area');
        if (area) {
            area.style.display = 'none';
            area.innerHTML = ''; 
        }
    }

    function generateMapPrintHtml() {
        // --- 1. Prepare Data ---
        let maxRow = 0; 
        let maxCol = 0; 
        
        stallsData.forEach(s => {
            const r = parseInt(s.row) || 0;
            const c = parseInt(s.col) || 0;
            if (r > maxRow) maxRow = r;
            if (c > maxCol) maxCol = c;
        });

        const bookingMap = {};
        const unpaidList = []; 
        
        if (bookingsData) {
            bookingsData.forEach(b => {
                bookingMap[b.stallName] = b;
                
                const isUnpaid = b.status === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞';
                const isDaily = b.type === '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô';
                const isRegular = b.note && b.note.includes('[‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥]');
                
                if (isUnpaid && (isDaily || isRegular)) {
                     unpaidList.push(b);
                }
            });
        }
        
        unpaidList.sort((a,b) => a.stallName.localeCompare(b.stallName, undefined, {numeric: true, sensitivity: 'base'}));

        // --- 2. Generate Grid HTML ---
        let gridHtml = '';
        
        for (let r=1; r<=maxRow; r++) {
            for (let c=1; c<=maxCol; c++) {
                const stall = stallsData.find(s => parseInt(s.row) == r && parseInt(s.col) == c);
                
                let cellContent = '';
                let bgStyle = 'background-color: transparent;'; 
                let borderStyle = 'border: 1px solid #eee;'; 
                
                if (stall) {
                    const booking = bookingMap[stall.name];
                    const isFood = stall.type.includes("‡∏≠‡∏≤‡∏´‡∏≤‡∏£");
                    const storage = (typeof globalStorageMap !== 'undefined') ? globalStorageMap[stall.name] : null;
                    
                    if (stall.type === "‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô") {
                        bgStyle = 'background-color: #9ca3af;'; 
                        borderStyle = 'border: 1px solid #6b7280;';
                    } else if (stall.type === "‡∏≠‡∏∑‡πà‡∏ô‡πÜ") {
                        bgStyle = 'background-color: #fef08a;'; 
                        borderStyle = 'border: 1px dashed #eab308;';
                    } else {
                        let stallLabel = `<div style="font-size: 9px; font-weight: bold; line-height: 1;">${stall.name}</div>`;
                        let productLabel = '';
                        let icons = '';

                        if (storage) {
                            icons += `<div style="position: absolute; top: 0; left: 0; font-size: 7px;">üì¶</div>`;
                        }
                        
                        if (booking) {
                            productLabel = `<div style="font-size: 7px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-top: 1px;">${booking.product || booking.bookerName}</div>`;
                            
                            if (booking.status === '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' || booking.status === '‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' || booking.status === '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á') {
                                // Paid
                                if(booking.type === '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô') {
                                     bgStyle = 'background-color: #fbcfe8;'; 
                                     borderStyle = 'border: 1px solid #f472b6;'; 
                                } else {
                                     bgStyle = 'background-color: #fecaca;'; 
                                     borderStyle = 'border: 1px solid #f87171;';
                                }
                            } else if (booking.status === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞') {
                                // Unpaid (Orange)
                                bgStyle = 'background-color: #fed7aa;'; 
                                borderStyle = 'border: 2px solid #ea580c;'; 
                                icons += `<div style="position: absolute; top: 0; right: 0; font-size: 8px;">‚ö†Ô∏è</div>`;
                            } else if (booking.status === '‡∏•‡∏≤') {
                                // Leave
                                bgStyle = 'background-color: #d1d5db;'; 
                                productLabel = '<div style="font-size: 7px; color: #4b5563;">‡∏•‡∏≤</div>';
                            }
                        } else {
                             // Free
                             if (isFood) {
                                 bgStyle = 'background-color: #dcfce7;'; 
                                 borderStyle = 'border: 1px solid #86efac;'; 
                             } else {
                                 bgStyle = 'background-color: #cffafe;'; 
                                 borderStyle = 'border: 1px solid #67e8f9;'; 
                             }
                             productLabel = `<div style="font-size: 7px; color: #9ca3af;">-</div>`;
                        }
                        
                        cellContent = `
                            <div style="position: relative; height: 100%; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                                ${icons}
                                ${stallLabel}
                                ${productLabel}
                            </div>
                        `;
                    }
                } else {
                    bgStyle = 'visibility: hidden;';
                    borderStyle = 'border: none;';
                }

                const cellStyle = `
                    grid-row: ${r};
                    grid-column: ${c};
                    ${bgStyle}
                    ${borderStyle}
                    border-radius: 1px;
                    overflow: hidden;
                    -webkit-print-color-adjust: exact !important; 
                    print-color-adjust: exact !important;
                `;
                
                gridHtml += `<div style="${cellStyle}">${cellContent}</div>`;
            }
        }

        // --- 3. Generate Unpaid List HTML ---
        let unpaidHtml = '';
        if (unpaidList.length > 0) {
            unpaidHtml = `
                <div style="border: 1px solid #ea580c; padding: 4px; display: flex; align-items: flex-start; gap: 10px; background-color: #fff7ed;">
                    <div style="font-weight: bold; font-size: 11px; white-space: nowrap; color: #c2410c;">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡∏õ‡∏£‡∏∞‡∏à‡∏≥):</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
            `;
            unpaidList.forEach(b => {
                unpaidHtml += `
                    <div style="font-size: 9px; border: 1px solid #f97316; padding: 1px 3px; border-radius: 2px; color: #9a3412; background-color: #ffedd5;">
                        <b>${b.stallName}</b> ${b.product}
                    </div>
                `;
            });
            unpaidHtml += `</div></div>`;
        } else {
            unpaidHtml = `<div style="font-size: 11px; text-align: center; padding: 4px; border: 1px dashed #16a34a; color: #16a34a;">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡∏õ‡∏£‡∏∞‡∏à‡∏≥) -</div>`;
        }

        // --- 4. Final Layout ---
        let dateStr = "-";
        if (typeof selectedDate !== 'undefined' && selectedDate) {
            const [y, m, d] = selectedDate.split('-');
            dateStr = `${parseInt(d)}/${parseInt(m)}/${parseInt(y) + 543}`;
        } else {
            const d = new Date();
            dateStr = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543}`;
        }
        
        const now = new Date();
        const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
        const officer = currentAdmin ? currentAdmin.name : "-";

        return `
            <div style="
                width: 297mm; 
                height: 200mm; 
                padding: 5mm 5mm; 
                box-sizing: border-box; 
                background: white;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                font-family: 'Sarabun', sans-serif;
                color: black;
            ">
                <!-- HEADER -->
                <div style="display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #000; padding-bottom: 3px; height: 10mm;">
                     <div>
                        <h1 style="margin: 0; font-size: 16px; font-weight: bold;">‡∏ú‡∏±‡∏á ${dateStr}</h1>
                        <div style="font-size: 11px;">‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå: ${timeStr} | ‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå: ${officer} | ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î‡∏•‡∏≤‡∏î‡∏™‡∏ß‡∏≤‡∏¢‡∏ß‡∏¥‡∏ô‡πÄ‡∏ó‡∏à</div>
                     </div>
                </div>

                <!-- MAP GRID -->
                <div style="
                    flex-grow: 1;
                    margin: 5px 0;
                    display: grid;
                    grid-template-columns: repeat(${maxCol}, 1fr);
                    grid-template-rows: repeat(${maxRow}, 1fr);
                    gap: 1px;
                    border: 1px solid #ccc;
                    width: 100%;
                    min-height: 0;
                ">
                    ${gridHtml}
                </div>

                <!-- FOOTER -->
                <div style="flex-shrink: 0; height: auto;">
                    ${unpaidHtml}
                    <!-- Signature -->
                    <div style="margin-top: 25px; display: flex; justify-content: flex-end; align-items: center; gap: 10px;">
                         <div style="font-size: 11px;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à:</div>
                         <div style="border-bottom: 1px dotted #000; width: 200px; height: 1em;"></div>
                    </div>
                </div>
            </div>

            <!-- CSS FOR PRINT -->
            <style>
                @media print {
                    @page { 
                        size: A4 landscape; 
                        margin: 0mm; 
                    }
                    body { 
                        margin: 0; 
                        padding: 0; 
                        -webkit-print-color-adjust: exact !important; 
                        print-color-adjust: exact !important;
                    }
                    /* EXPLICITLY HIDE TICKETS IN MAP PRINT MODE */
                    #ticket-area, #monthly-ticket-area { display: none !important; }
                    
                    /* SHOW MAP */
                    #report-print-area, #report-print-area * { visibility: visible !important; }
                    #report-print-area {
                        position: absolute;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        z-index: 99999;
                        background: white;
                        display: block !important;
                    }
                    
                    .no-print { display: none !important; }
                }
            </style>
        `;
    }
</script>