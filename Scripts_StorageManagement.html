<script>
    /**
     * Scripts_StorageManagement
     * Logic สำหรับหน้าจัดการฝากของ (List View)
     * หน้าที่: ดึงข้อมูล, กรองข้อมูล, แสดงผลตาราง
     * Update: แยก Action (Move, Return, Print) ไปไว้ที่ Scripts_Storage.html แล้ว
     */

    let storageDataCache = [];

    function openStorageManagementModal() {
        if (!currentAdmin) return;
        
        const modal = document.getElementById('storageManagementModal');
        if (!modal) {
            console.error("Error: Modal #storageManagementModal not found in DOM");
            return;
        }

        // Force remove 'hidden' class first (Tailwind)
        modal.classList.remove('hidden');
        
        // Use shared showModal to handle opacity/pointer-events and body scroll
        if (typeof showModal === 'function') {
            showModal('storageManagementModal');
        } else {
            // Fallback if Scripts_UI not loaded
            modal.style.display = 'flex';
            document.body.classList.add('modal-active');
        }

        fetchStorageList();
    }

    function closeStorageManagementModal() {
        // Use shared hideModal for animation/cleanup
        if (typeof hideModal === 'function') {
            hideModal('storageManagementModal');
        } else {
            const modal = document.getElementById('storageManagementModal');
            if(modal) modal.classList.add('hidden');
            document.body.classList.remove('modal-active');
        }
    }

    function fetchStorageList() {
        const loader = document.getElementById('store_loading');
        const noData = document.getElementById('store_noData');
        const tbody = document.getElementById('store_tableBody');
        
        if (loader) loader.classList.remove('hidden');
        if (noData) noData.classList.add('hidden');
        if (tbody) tbody.innerHTML = '';

        google.script.run
            .withSuccessHandler((res) => {
                if (loader) loader.classList.add('hidden');
                if (res.success) {
                    storageDataCache = res.data;
                    filterStorageList();
                } else {
                    if (typeof showAlert === 'function') {
                        showAlert(res.message, "ข้อผิดพลาด", true);
                    } else {
                        alert(res.message);
                    }
                }
            })
            .withFailureHandler((err) => {
                if (loader) loader.classList.add('hidden');
                if (typeof showAlert === 'function') {
                    showAlert("Error: " + err, "ข้อผิดพลาด", true);
                } else {
                    console.error(err);
                }
            })
            .getStorageList();
    }

    function filterStorageList() {
        const searchInput = document.getElementById('store_searchInput');
        const filterStatus = document.getElementById('store_filterStatus');
        
        if (!searchInput || !filterStatus) return;

        const searchText = searchInput.value.toLowerCase();
        const statusVal = filterStatus.value;
        const tbody = document.getElementById('store_tableBody');
        const countInfo = document.getElementById('store_countInfo');
        const noData = document.getElementById('store_noData');

        tbody.innerHTML = '';

        const filtered = storageDataCache.filter(item => {
            const matchSearch = 
                (item.stallName && item.stallName.toLowerCase().includes(searchText)) ||
                (item.ownerName && item.ownerName.toLowerCase().includes(searchText)) ||
                (item.phone && item.phone.includes(searchText));
            
            let matchStatus = true;
            if (statusVal === 'Active') matchStatus = (item.status === 'Active');
            if (statusVal === 'Completed') matchStatus = (item.status === 'Completed');
            
            return matchSearch && matchStatus;
        });

        if (filtered.length === 0) {
            noData.classList.remove('hidden');
            countInfo.innerText = "รายการทั้งหมด: 0";
            return;
        }

        noData.classList.add('hidden');
        countInfo.innerText = `รายการทั้งหมด: ${filtered.length}`;

        const today = new Date();
        today.setHours(0,0,0,0);

        filtered.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-orange-50 border-b last:border-0 transition-colors";
            
            const endDate = new Date(item.endDate);
            endDate.setHours(0,0,0,0);
            
            // Calculate Days Remaining
            const diffTime = endDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            const isExpired = (item.status === 'Active' && diffDays < 0);
            
            let statusBadge = '<span class="bg-gray-100 text-gray-500 px-2 py-1 rounded-full text-xs font-bold border border-gray-200">คืนแล้ว</span>';
            let daysTag = '';

            if (item.status === 'Active') {
                if (item.stallName === 'Holding Area') {
                    statusBadge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-bold border border-yellow-200"><i class="fa-solid fa-warehouse mr-1"></i>จุดพัก</span>';
                } else if (isExpired) {
                    statusBadge = '<span class="bg-red-100 text-red-600 px-2 py-1 rounded-full text-xs font-bold border border-red-200">เกินกำหนด</span>';
                } else {
                    statusBadge = '<span class="bg-green-100 text-green-600 px-2 py-1 rounded-full text-xs font-bold border border-green-200">ฝากอยู่</span>';
                }

                // Days Remaining Tag
                if (diffDays < 0) {
                    daysTag = `<div class="mt-1 text-[10px] text-red-600 font-bold bg-red-50 inline-block px-1.5 rounded border border-red-200">เกิน ${Math.abs(diffDays)} วัน</div>`;
                } else if (diffDays === 0) {
                    daysTag = `<div class="mt-1 text-[10px] text-orange-600 font-bold bg-orange-50 inline-block px-1.5 rounded border border-orange-200">หมดอายุวันนี้</div>`;
                } else if (diffDays <= 2) {
                    daysTag = `<div class="mt-1 text-[10px] text-orange-600 font-bold bg-orange-50 inline-block px-1.5 rounded border border-orange-200">เหลือ ${diffDays} วัน</div>`;
                } else {
                    daysTag = `<div class="mt-1 text-[10px] text-blue-600 font-bold bg-blue-50 inline-block px-1.5 rounded border border-blue-200">เหลือ ${diffDays} วัน</div>`;
                }
            }

            // Actions: Print is always available. Move/Return only for Active.
            // Note: These functions are defined in Scripts_Storage.html
            let actions = `
                <button onclick="handleReprintStorage('${item.id}')" class="text-gray-500 hover:text-blue-600 p-1.5 rounded-full hover:bg-blue-50 transition" title="พิมพ์ตั๋วซ้ำ"><i class="fa-solid fa-print"></i></button>
            `;
            
            if (item.status === 'Active') {
                actions += `
                    <button onclick="openStorageMoveModal('${item.id}', '${item.stallName}')" class="text-blue-500 hover:text-blue-700 p-1.5 rounded-full hover:bg-blue-50 transition ml-1" title="ย้ายตำแหน่ง"><i class="fa-solid fa-dolly text-lg"></i></button>
                `;
                actions += `
                    <button onclick="handleReturnStorage('${item.id}', '${item.stallName}')" class="text-green-500 hover:text-green-700 p-1.5 rounded-full hover:bg-green-50 transition ml-1" title="คืนของ (จบงาน)"><i class="fa-solid fa-check-circle text-lg"></i></button>
                `;
            }

            const startStr = (typeof formatThaiDateShort === 'function') ? formatThaiDateShort(item.startDate) : item.startDate;
            const endStr = (typeof formatThaiDateShort === 'function') ? formatThaiDateShort(item.endDate) : item.endDate;

            tr.innerHTML = `
                <td class="px-4 py-3 text-center text-gray-400 text-xs">${index + 1}</td>
                <td class="px-4 py-3">
                    <div class="text-xs font-bold text-gray-700">${startStr}</div>
                    <div class="text-[10px] text-gray-400">ถึง ${endStr}</div>
                    ${daysTag}
                </td>
                <td class="px-4 py-3 font-bold ${item.stallName === 'Holding Area' ? 'text-yellow-600' : 'text-orange-600'} text-lg">${item.stallName}</td>
                <td class="px-4 py-3">
                    <div class="font-bold text-gray-800">${item.ownerName}</div>
                    <div class="text-xs text-gray-500"><i class="fa-solid fa-phone mr-1"></i>${item.phone || "-"}</div>
                </td>
                <td class="px-4 py-3 text-xs text-gray-500 italic max-w-[150px] truncate">${item.note || "-"}</td>
                <td class="px-4 py-3 text-center">${statusBadge}</td>
                <td class="px-4 py-3 text-center whitespace-nowrap">${actions}</td>
            `;
            tbody.appendChild(tr);
        });
    }
</script>