<!-- Monthly Management Modal -->
<div id="monthlyManagementModal" style="display:none;" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="closeMonthlyManagementModal()"></div>
    <div class="modal-container bg-white w-11/12 md:max-w-5xl mx-auto rounded-xl shadow-lg z-50 overflow-hidden flex flex-col h-[85vh]"> 
        
        <div class="modal-header flex flex-col xl:flex-row justify-between items-center px-4 py-3 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-indigo-50 shrink-0 gap-3">
            <div class="flex items-center gap-4 w-full xl:w-auto justify-between xl:justify-start">
                <h3 class="font-bold text-base text-purple-800 whitespace-nowrap flex items-center"><i class="fa-solid fa-calendar-check mr-2"></i>ข้อมูลรายเดือน</h3>
                <div class="xl:hidden cursor-pointer bg-white rounded-full p-1.5 hover:bg-red-50 text-gray-400 hover:text-red-500 transition shadow-sm" onclick="closeMonthlyManagementModal()"><i class="fa-solid fa-times text-base"></i></div>
            </div>

            <div class="flex flex-wrap xl:flex-nowrap items-center gap-2 w-full xl:w-auto justify-center xl:justify-end">
                <div class="flex gap-2">
                    <button onclick="startNewMonthlyBooking()" class="px-3 py-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 shadow-sm transition text-xs font-bold whitespace-nowrap flex items-center gap-1"><i class="fa-solid fa-plus-circle"></i> จองใหม่</button>
                    <button onclick="openRenewalModal()" class="px-3 py-1.5 bg-white border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 shadow-sm transition text-xs font-bold whitespace-nowrap flex items-center gap-1"><i class="fa-solid fa-arrows-rotate"></i> ต่อสัญญา</button>
                    <button id="btnBatchRecalc" onclick="runBatchRecalculate()" class="hidden px-3 py-1.5 bg-gray-100 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-200 shadow-sm transition text-xs font-bold whitespace-nowrap flex items-center gap-1" title="ซ่อมยอดเงินทั้งหมดให้ถูกต้อง (เฉพาะ Super Admin)"><i class="fa-solid fa-wrench"></i> ซ่อมยอด</button>
                </div>

                <div class="h-6 w-px bg-gray-300 mx-1 hidden xl:block"></div>

                <div class="flex gap-2 flex-1 xl:flex-none">
                    <div class="relative w-32 shrink-0">
                        <select id="monthlyFilterMonth" onchange="filterMonthlyData()" class="w-full pl-2 pr-6 py-1.5 border border-purple-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-purple-400 text-xs appearance-none bg-white font-medium text-gray-700 cursor-pointer shadow-sm"><option value="">ทุกเดือน</option></select>
                        <i class="fa-solid fa-chevron-down absolute right-2 top-2 text-purple-400 text-[10px] pointer-events-none"></i>
                    </div>
                    <div class="relative w-full xl:w-48">
                        <input type="text" id="monthlySearchInput" onkeyup="filterMonthlyData()" placeholder="ค้นหา..." class="w-full pl-7 pr-2 py-1.5 border border-purple-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-purple-400 text-xs shadow-sm">
                        <i class="fa-solid fa-magnifying-glass absolute left-2.5 top-2 text-purple-400 text-xs"></i>
                    </div>
                </div>
            </div>

            <div class="hidden xl:block cursor-pointer bg-white rounded-full p-1.5 hover:bg-red-50 text-gray-400 hover:text-red-500 transition shadow-sm ml-2" onclick="closeMonthlyManagementModal()"><i class="fa-solid fa-times text-lg"></i></div>
        </div>

        <div class="modal-content flex-1 overflow-y-auto p-4 bg-gray-50 flex flex-col gap-4">
            <div id="monthlyDataContainer" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden relative flex-1 flex flex-col">
                <div id="monthlyLoading" class="flex flex-col items-center justify-center h-full text-gray-400 absolute inset-0 bg-white z-20 hidden">
                    <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-2"></i>
                    <p class="text-sm">กำลังโหลดข้อมูล...</p>
                </div>
                
                <div class="overflow-auto flex-1">
                    <table class="min-w-full text-left text-sm hidden" id="monthlyTable">
                        <thead class="bg-gray-50 text-gray-600 font-bold sticky top-0 z-10 border-b text-xs">
                            <tr>
                                <th class="px-4 py-2 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition" onclick="sortMonthlyData('bookingMonth')">เดือน <i class="fa-solid fa-sort text-gray-300 ml-1"></i></th>
                                <th class="px-4 py-2 whitespace-nowrap text-center cursor-pointer hover:bg-gray-100 transition" onclick="sortMonthlyData('customerType')">ประเภท <i class="fa-solid fa-sort text-gray-300 ml-1"></i></th>
                                <th class="px-4 py-2 cursor-pointer hover:bg-gray-100 transition" onclick="sortMonthlyData('bookerName')">ลูกค้า/สินค้า <i class="fa-solid fa-sort text-gray-300 ml-1"></i></th>
                                <th class="px-4 py-2 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition" onclick="sortMonthlyData('stalls')">ล็อค <i class="fa-solid fa-sort text-gray-300 ml-1"></i></th>
                                <th class="px-4 py-2 text-right whitespace-nowrap cursor-pointer hover:bg-gray-100 transition" onclick="sortMonthlyData('totalPrice')">ยอดรวม <i class="fa-solid fa-sort text-gray-300 ml-1"></i></th>
                                <th class="px-4 py-2 text-right whitespace-nowrap cursor-pointer hover:bg-gray-100 transition" onclick="sortMonthlyData('paid')">ชำระแล้ว <i class="fa-solid fa-sort text-gray-300 ml-1"></i></th>
                                <th class="px-4 py-2 text-right whitespace-nowrap">คงเหลือ</th>
                                <th class="px-4 py-2 text-center whitespace-nowrap">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100" id="monthlyTableBody"></tbody>
                    </table>
                </div>

                <div id="monthlyNoData" class="hidden flex flex-col items-center justify-center h-full text-gray-400 min-h-[200px]">
                    <i class="fa-solid fa-inbox text-3xl mb-2"></i>
                    <p class="text-sm">ไม่พบข้อมูล</p>
                </div>
            </div>

            <div id="monthlyPagination" class="flex justify-between items-center px-2 shrink-0">
                <button onclick="changeMonthlyPage(-1)" id="btnPrevPage" class="px-3 py-1.5 bg-white border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 text-xs font-bold disabled:opacity-50 disabled:cursor-not-allowed shadow-sm transition flex items-center gap-1"><i class="fa-solid fa-chevron-left"></i> ก่อนหน้า</button>
                <span id="pageIndicator" class="text-xs font-bold text-gray-500 bg-white border border-gray-200 px-3 py-1 rounded-full shadow-sm">หน้า 1 / 1</span>
                <button onclick="changeMonthlyPage(1)" id="btnNextPage" class="px-3 py-1.5 bg-white border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 text-xs font-bold disabled:opacity-50 disabled:cursor-not-allowed shadow-sm transition flex items-center gap-1">ถัดไป <i class="fa-solid fa-chevron-right"></i></button>
            </div>

            <div id="paymentDetailContainer" class="bg-white border border-gray-200 rounded-xl p-4 min-h-[200px] transition-all duration-300 ease-in-out shrink-0 shadow-sm">
                <div id="paymentPlaceholder" class="flex flex-col items-center justify-center text-center h-full text-gray-400 py-4">
                    <i class="fa-solid fa-hand-pointer text-2xl mb-1"></i>
                    <span class="text-sm">คลิกที่รายการด้านบนเพื่อดูประวัติการชำระเงิน</span>
                </div>
                <div id="paymentContent" class="hidden h-full flex flex-col">
                    <div class="flex justify-between items-center mb-2 pb-2 border-b shrink-0">
                            <div class="flex flex-col md:flex-row md:items-center gap-1 md:gap-3">
                                <h4 class="font-bold text-gray-700 text-sm whitespace-nowrap"><i class="fa-solid fa-money-bill-transfer mr-1"></i> ประวัติการชำระเงิน</h4>
                                <span class="hidden md:inline text-gray-300">|</span>
                                <span id="selectedBookingRef" class="text-sm font-bold text-purple-700 truncate"></span>
                            </div>
                            <!-- FIX: Added Preview Button next to Print -->
                            <div class="flex gap-2">
                                <button id="btnPreviewMonthlyHeader" class="hidden items-center justify-center bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-700 transition-colors shadow-sm gap-2">
                                    <i class="fa-solid fa-eye"></i> ดู
                                </button>
                                <button id="btnPrintMonthlyHeader" class="hidden items-center justify-center bg-gray-800 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-black transition-colors shadow-sm gap-2">
                                    <i class="fa-solid fa-print"></i> พิมพ์
                                </button>
                            </div>
                    </div>
                    <div class="overflow-x-auto flex-1">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-gray-100 text-gray-600 sticky top-0">
                                <tr>
                                    <th class="px-2 py-2 text-center rounded-tl-lg">วันที่</th>
                                    <th class="px-2 py-2 text-center">เวลา</th>
                                    <th class="px-2 py-2 text-center">ยอดชำระ</th>
                                    <th class="px-2 py-2 text-center">ช่องทาง</th>
                                    <th class="px-2 py-2 text-center">สลิป</th>
                                    <th class="px-2 py-2 text-center">โน้ต</th>
                                    <th class="px-2 py-2 text-center rounded-tr-lg">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="paymentHistoryBody" class="divide-y divide-gray-100 bg-white text-center"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>