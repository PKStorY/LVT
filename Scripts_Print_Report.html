<script>
    /**
     * Scripts_Print_Report
     * จัดการการสร้างและพิมพ์รายงานประจำวัน (Daily Closing Report)
     * VERSION: PREVIEW FIRST (Manual Print)
     */

    function printDailyReport(data, dateStr, actualCash, diffCash, note) {
        if (!data || !data.accounting) {
            alert("ไม่พบข้อมูลบัญชี");
            return;
        }

        if (typeof generateDailyReportHtml !== 'function') {
            console.error("Error: generateDailyReportHtml function not found.");
            alert("Error: Template_Report.html not loaded.");
            return;
        }

        try {
            const reportHtml = generateDailyReportHtml(data, dateStr, actualCash, diffCash, note);
            const printArea = getOrCreatePrintArea('report-print-area');
            
            // Inject content WITH Control Bar (Vintage/Modern Mix)
            // .no-print class will hide this bar when printing
            const controls = `
                <div class="no-print" style="
                    position: sticky; top: 0; left: 0; width: 100%; 
                    background: #4A3B32; color: #FDF5E6; padding: 12px 20px; 
                    display: flex; justify-content: space-between; align-items: center;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 10001;
                    font-family: 'Sarabun', sans-serif;
                ">
                    <div style="font-weight: bold; font-size: 16px;">
                        <i class="fa-solid fa-eye"></i> ตัวอย่างรายงาน (Preview Mode)
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="window.print()" style="
                            background: #2E7D32; color: white; border: 1px solid #1B5E20; 
                            padding: 6px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;
                            display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        ">
                            <i class="fa-solid fa-print"></i> สั่งพิมพ์
                        </button>
                        <button onclick="document.getElementById('report-print-area').style.display='none'" style="
                            background: #C62828; color: white; border: 1px solid #B71C1C; 
                            padding: 6px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;
                            display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        ">
                            <i class="fa-solid fa-times"></i> ปิด
                        </button>
                    </div>
                </div>
                <div style="padding: 40px 0; display: flex; justify-content: center;">
                    ${reportHtml}
                </div>
            `;
            
            printArea.innerHTML = controls;
            printArea.style.display = 'block';
            
            // REMOVED: setTimeout window.print() to stop auto-popup
            
        } catch(e) {
            console.error("Print Error:", e);
            alert("เกิดข้อผิดพลาดในการสร้างรายงาน: " + e.message);
        }
    }

    function getOrCreatePrintArea(id) {
        let el = document.getElementById(id);
        if (!el) {
            el = document.createElement('div');
            el.id = id;
            // Style as a dark overlay modal
            el.style.position = 'fixed';
            el.style.top = '0';
            el.style.left = '0';
            el.style.width = '100%';
            el.style.height = '100%';
            el.style.zIndex = '9999';
            el.style.backgroundColor = 'rgba(62, 39, 35, 0.9)'; // Dark Brown Overlay
            el.style.display = 'none';
            el.style.overflow = 'auto'; // Allow scrolling the A4 paper
            document.body.appendChild(el);
        }
        return el;
    }
</script>