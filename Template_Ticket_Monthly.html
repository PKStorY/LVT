<script>
    /**
     * TEMPLATE: MONTHLY TICKET
     * โครงสร้าง HTML สำหรับตั๋วรายเดือน (Thermal Printer 80mm Layout)
     * Update: Layout & Font sizes as per specific requirements
     */
    function generateMonthlyTicketHtml(data) {
        const {
            paymentId, paymentDateTime, bookingMonth, bookerName, productName,
            dayDetails, storageFee, paymentHistory,
            priceExVat, vat, grandTotal, totalPaid, percent, remaining,
            officerName,
            currentPaymentAmount, currentPaymentMethod
        } = data;

        // Helper: Format number with commas and 2 decimals
        const fmt = (n) => parseFloat(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        // Helper: Format number with commas and no decimals
        const fmtNoDec = (n) => parseFloat(n || 0).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });

        const IMG_LOGO_URL = "https://img2.pic.in.th/pic/Profile-Alpha_0.png";
        const IMG_QR_URL = "https://img5.pic.in.th/file/secure-sv1/S_gainfriends_2dbarcodes_BW73c64bbdc0272b36.png";

        // --- 1. Day Rows Logic ---
        let dayRows = "";
        const getDayData = (label) => dayDetails.find(d => d.dayLabel.includes(label));
        const daysOrder = ["วันพุธ", "วันเสาร์", "วันอาทิตย์"];
        
        daysOrder.forEach(dayName => {
            const d = getDayData(dayName);
            // แสดงเฉพาะวันที่มีการเลือก (count > 0)
            if (d && d.count > 0) {
                // Format: ([Price] x [Count]) + ([Elec] x [Count])
                // Note: Price and Elec per unit show no decimals
                const calcStr = `(${fmtNoDec(d.pricePerDay)} x ${d.count}) + (${fmtNoDec(d.elecCostPerDay)} x ${d.count})`;
                
                dayRows += `
                    <div style="margin-bottom: 2px;">
                        <div style="font-weight: bold; text-align: left; font-size: 14px;">
                            ${d.dayLabel} ล็อค : ${d.stalls}
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 14px;">
                            <span style="text-align: left; padding-left: 20px;">${calcStr}</span>
                            <span style="text-align: right;">${fmt(d.total)}</span>
                        </div>
                    </div>
                `;
            }
        });

        // Storage Fee Row
        let storageRow = "";
        if (parseFloat(storageFee) > 0) {
            storageRow = `
                <div style="display: flex; justify-content: space-between; margin-top: 2px; font-size: 14px;">
                    <span style="text-align: left;">ค่าฝากของ</span>
                    <span style="text-align: right;">${fmt(storageFee)}</span>
                </div>
            `;
        }

        // --- 2. Payment History Logic ---
        let historyRows = "";
        paymentHistory.forEach(h => {
            // h.date format expected from server: "DD MMM YYYY" (e.g. 22 ธ.ค. 2568)
            // Ensure alignment: Left, Center, Right
            historyRows += `
                <div style="display: flex; width: 100%; font-size: 14px; margin-bottom: 2px;">
                    <div style="width: 35%; text-align: left;">${h.date}</div>
                    <div style="width: 30%; text-align: center;">${h.method}</div>
                    <div style="width: 35%; text-align: right;">${fmt(h.amount)}</div>
                </div>
            `;
        });

        // --- 3. Summary Section Calculations ---
        const sumVatBase = fmt(priceExVat);
        const sumVatAmt = fmt(vat);
        const sumTotal = fmt(grandTotal);
        const sumPaid = fmt(totalPaid);
        const sumPercent = percent.toFixed(0) + "%";
        const sumRemain = fmt(remaining > 0 ? remaining : 0);

        return `
            <div style="font-family: 'Sarabun', sans-serif; color: black; line-height: 1.3; width: 100%; max-width: 300px; margin: 0 auto; background: white; padding: 10px 5px;">
                
                <!-- 1. Header -->
                <div style="text-align: center;">
                    <img src="${IMG_LOGO_URL}" style="width: 90px; height: auto; margin: 0 auto; display: block;" loading="eager">
                    <div style="font-size: 18px; font-weight: bold; margin-top: 5px;">ตลาดนัดลาดสวายวินเทจ</div>
                    <div style="font-size: 14px;">เลขที่ 52/34 หมู่ 5</div>
                    <div style="font-size: 14px;">ต.ลาดสวาย อ.ลำลูกกา จ.ปทุมธานี 12150</div>
                    <div style="font-size: 14px;">โทร: 0-92-869-7774 , 0-92-869-7775</div>
                    <div style="border-bottom: 1px dashed #000; margin: 5px 0;"></div>
                    <div style="font-size: 16px; font-weight: bold;">ตั๋ว/ใบเสร็จ (รายเดือน)</div>
                </div>

                <!-- 2. Bill Info -->
                <div style="margin-top: 5px; font-size: 14px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="text-align: left;">เลขที่ :</span>
                        <span style="text-align: right;">${paymentId}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="text-align: left;">วันที่ทำรายการ :</span>
                        <span style="text-align: right;">${paymentDateTime}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="text-align: left;">รหัสพนักงาน :</span>
                        <span style="text-align: right;">${officerName}</span>
                    </div>
                </div>
                <div style="height: 0.5em;"></div>

                <!-- 3. Customer Info -->
                <div style="font-size: 16px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="text-align: left;">ประจำเดือน : </span>
                        <span style="text-align: right; font-weight: bold;">${bookingMonth}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="text-align: left;">ผู้จอง : </span>
                        <span style="text-align: right; font-weight: bold;">${bookerName}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="text-align: left;">สินค้า : </span>
                        <span style="text-align: right; font-weight: bold;">${productName}</span>
                    </div>
                </div>
                <div style="border-bottom: 1px dashed #000; margin: 5px 0;"></div>

                <!-- 4. Details -->
                <div style="padding: 2px 0;">
                    ${dayRows}
                    ${storageRow}
                </div>
                <div style="border-bottom: 1px dashed #000; margin: 5px 0;"></div>

                <!-- 5. Payment History -->
                <div style="font-size: 14px; padding: 2px 0;">
                    <div style="display: flex; width: 100%; font-weight: bold; margin-bottom: 4px;">
                        <div style="width: 35%; text-align: left;">วันชำระ</div>
                        <div style="width: 30%; text-align: center;">ช่องทางชำระ</div>
                        <div style="width: 35%; text-align: right;">จำนวนเงิน</div>
                    </div>
                    ${historyRows}
                </div>
                <div style="border-bottom: 1px dashed #000; margin: 5px 0;"></div>

                <!-- 6. Summary & Tax -->
                <div style="margin-top: 2px; font-size: 14px;">
                    <!-- Use Flexbox for 2 Columns alignment -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                        <div style="text-align: right; width: 60%;">ราคาไม่รวมภาษีมูลค่าเพิ่ม : </div>
                        <div style="text-align: right; width: 40%;">${sumVatBase}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                        <div style="text-align: right; width: 60%;">ภาษีมูลค่าเพิ่ม 7% : </div>
                        <div style="text-align: right; width: 40%;">${sumVatAmt}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                        <div style="text-align: right; width: 60%; font-weight: bold;">รวมเป็นเงินทั้งสิ้น : </div>
                        <div style="text-align: right; width: 40%; font-weight: bold; font-size: 16px;">${sumTotal}</div>
                    </div>
                    
                    <!-- Dashed Line 20% on the right column -->
                    <div style="display: flex; justify-content: flex-end; margin: 4px 0;">
                        <div style="width: 40%; border-bottom: 1px dashed #000;"></div>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                        <div style="text-align: right; width: 60%;">ชำระแล้วรวมทั้งสิ้น : </div>
                        <div style="text-align: right; width: 40%;">${sumPaid}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                        <div style="text-align: right; width: 60%;">คิดเป็นเปอร์เซ็น : </div>
                        <div style="text-align: right; width: 40%;">${sumPercent}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                        <div style="text-align: right; width: 60%;">ค้างชำระ/คงเหลือ : </div>
                        <div style="text-align: right; width: 40%; font-weight: bold; font-size: 16px;">${sumRemain}</div>
                    </div>
                </div>
                <div style="border-bottom: 1px dashed #000; margin: 5px 0;"></div>

                <!-- 7. Footer -->
                <div style="margin-top: 15px; text-align: center;">
                    <div style="font-size: 12px; margin-bottom: 5px;">สอบถามค่าล็อค ส่งสลิป ได้ที่</div>
                    <img src="${IMG_QR_URL}" style="width: 100px; height: auto; margin: 0 auto; display: block;" loading="eager">
                    <div style="font-size: 12px; margin-top: 5px;">@ladsawaivintage</div>
                    <div style="height: 2px;"></div>
                    <div style="font-size: 8px;">Power by PJMJK</div>
                </div>
            </div>
        `;
    }
</script>