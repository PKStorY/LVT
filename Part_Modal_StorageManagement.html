<script>
    /**
     * Scripts_StorageManagement
     * Logic สำหรับหน้าจัดการฝากของ (List, Return, Reprint, Move)
     * Update: Added "Days Remaining" Tag to Table
     */

    let storageDataCache = [];

    function openStorageManagementModal() {
        if (!currentAdmin) return;
        document.getElementById('storageManagementModal').classList.remove('hidden');
        if (!document.body.classList.contains('modal-active')) {
            const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
            if (scrollbarWidth > 0) document.body.style.paddingRight = `${scrollbarWidth}px`;
            document.body.classList.add('modal-active');
        }
        fetchStorageList();
    }

    function closeStorageManagementModal() {
        document.getElementById('storageManagementModal').classList.add('hidden');
        document.body.classList.remove('modal-active');
        document.body.style.paddingRight = '';
    }

    function fetchStorageList() {
        const loader = document.getElementById('store_loading');
        const noData = document.getElementById('store_noData');
        const tbody = document.getElementById('store_tableBody');
        
        if (loader) loader.classList.remove('hidden');
        if (noData) noData.classList.add('hidden');
        if (tbody) tbody.innerHTML = '';

        google.script.run
            .withSuccessHandler((res) => {
                if (loader) loader.classList.add('hidden');
                if (res.success) {
                    storageDataCache = res.data;
                    filterStorageList();
                } else {
                    showAlert(res.message, "ข้อผิดพลาด", true);
                }
            })
            .withFailureHandler((err) => {
                if (loader) loader.classList.add('hidden');
                showAlert("Error: " + err, "ข้อผิดพลาด", true);
            })
            .getStorageList();
    }

    function filterStorageList() {
        const searchText = document.getElementById('store_searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('store_filterStatus').value;
        const tbody = document.getElementById('store_tableBody');
        const countInfo = document.getElementById('store_countInfo');
        const noData = document.getElementById('store_noData');

        tbody.innerHTML = '';

        const filtered = storageDataCache.filter(item => {
            const matchSearch = 
                (item.stallName && item.stallName.toLowerCase().includes(searchText)) ||
                (item.ownerName && item.ownerName.toLowerCase().includes(searchText)) ||
                (item.phone && item.phone.includes(searchText));
            
            let matchStatus = true;
            if (statusFilter === 'Active') matchStatus = (item.status === 'Active');
            if (statusFilter === 'Completed') matchStatus = (item.status === 'Completed');
            
            return matchSearch && matchStatus;
        });

        if (filtered.length === 0) {
            noData.classList.remove('hidden');
            countInfo.innerText = "รายการทั้งหมด: 0";
            return;
        }

        noData.classList.add('hidden');
        countInfo.innerText = `รายการทั้งหมด: ${filtered.length}`;

        const today = new Date();
        today.setHours(0,0,0,0);

        filtered.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-orange-50 border-b last:border-0 transition-colors";
            
            const endDate = new Date(item.endDate);
            endDate.setHours(0,0,0,0);
            
            // Calculate Days Remaining
            const diffTime = endDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            const isExpired = (item.status === 'Active' && diffDays < 0);
            
            let statusBadge = '<span class="bg-gray-100 text-gray-500 px-2 py-1 rounded-full text-xs font-bold border border-gray-200">คืนแล้ว</span>';
            let daysTag = '';

            if (item.status === 'Active') {
                if (item.stallName === 'Holding Area') {
                    statusBadge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-bold border border-yellow-200"><i class="fa-solid fa-warehouse mr-1"></i>จุดพัก</span>';
                } else if (isExpired) {
                    statusBadge = '<span class="bg-red-100 text-red-600 px-2 py-1 rounded-full text-xs font-bold border border-red-200">เกินกำหนด</span>';
                } else {
                    statusBadge = '<span class="bg-green-100 text-green-600 px-2 py-1 rounded-full text-xs font-bold border border-green-200">ฝากอยู่</span>';
                }

                // Logic for Days Remaining Tag
                if (diffDays < 0) {
                    daysTag = `<div class="mt-1 text-[10px] text-red-600 font-bold bg-red-50 inline-block px-1.5 rounded border border-red-200">เกิน ${Math.abs(diffDays)} วัน</div>`;
                } else if (diffDays === 0) {
                    daysTag = `<div class="mt-1 text-[10px] text-orange-600 font-bold bg-orange-50 inline-block px-1.5 rounded border border-orange-200">หมดอายุวันนี้</div>`;
                } else if (diffDays <= 2) {
                    daysTag = `<div class="mt-1 text-[10px] text-orange-600 font-bold bg-orange-50 inline-block px-1.5 rounded border border-orange-200">เหลือ ${diffDays} วัน</div>`;
                } else {
                    daysTag = `<div class="mt-1 text-[10px] text-blue-600 font-bold bg-blue-50 inline-block px-1.5 rounded border border-blue-200">เหลือ ${diffDays} วัน</div>`;
                }
            }

            let actions = `
                <button onclick="handleReprintStorage('${item.id}')" class="text-gray-500 hover:text-blue-600 p-1.5 rounded-full hover:bg-blue-50 transition" title="พิมพ์ตั๋วซ้ำ"><i class="fa-solid fa-print"></i></button>
            `;
            
            if (item.status === 'Active') {
                actions += `
                    <button onclick="openStorageMoveModal('${item.id}', '${item.stallName}')" class="text-blue-500 hover:text-blue-700 p-1.5 rounded-full hover:bg-blue-50 transition ml-1" title="ย้ายตำแหน่ง"><i class="fa-solid fa-dolly text-lg"></i></button>
                `;
                actions += `
                    <button onclick="handleReturnStorage('${item.id}', '${item.stallName}')" class="text-green-500 hover:text-green-700 p-1.5 rounded-full hover:bg-green-50 transition ml-1" title="คืนของ (จบงาน)"><i class="fa-solid fa-check-circle text-lg"></i></button>
                `;
            }

            const startStr = formatThaiDateShort(item.startDate);
            const endStr = formatThaiDateShort(item.endDate);

            tr.innerHTML = `
                <td class="px-4 py-3 text-center text-gray-400 text-xs">${index + 1}</td>
                <td class="px-4 py-3">
                    <div class="text-xs font-bold text-gray-700">${startStr}</div>
                    <div class="text-[10px] text-gray-400">ถึง ${endStr}</div>
                    ${daysTag}
                </td>
                <td class="px-4 py-3 font-bold ${item.stallName === 'Holding Area' ? 'text-yellow-600' : 'text-orange-600'} text-lg">${item.stallName}</td>
                <td class="px-4 py-3">
                    <div class="font-bold text-gray-800">${item.ownerName}</div>
                    <div class="text-xs text-gray-500"><i class="fa-solid fa-phone mr-1"></i>${item.phone || "-"}</div>
                </td>
                <td class="px-4 py-3 text-xs text-gray-500 italic max-w-[150px] truncate">${item.note || "-"}</td>
                <td class="px-4 py-3 text-center">${statusBadge}</td>
                <td class="px-4 py-3 text-center whitespace-nowrap">${actions}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- MOVE LOGIC ---
    function openStorageMoveModal(id, currentLoc) {
        document.getElementById('mv_storage_id').value = id;
        document.getElementById('mv_current_location').value = currentLoc;
        document.getElementById('mv_display_current').innerText = currentLoc;
        
        // Reset Search & Dropdown
        document.getElementById('mv_stallSearch').value = "";
        document.getElementById('mv_target_stall').value = "";
        document.getElementById('mv_stallDropdownList').classList.add('hidden');
        
        const btnHolding = document.getElementById('opt_move_holding');
        if (currentLoc === 'Holding Area') {
            btnHolding.classList.add('hidden');
        } else {
            btnHolding.classList.remove('hidden');
        }
        
        validateMoveInput();
        document.getElementById('storageMoveModal').classList.remove('hidden');
    }

    function closeStorageMoveModal() {
        document.getElementById('storageMoveModal').classList.add('hidden');
    }

    function selectMoveOption(target) {
        if(target === 'Holding Area') {
            submitMoveToLocation('Holding Area');
        }
    }

    // --- NEW: Dropdown Logic for Storage Move ---
    function toggleMoveStorageDropdown() {
        const list = document.getElementById('mv_stallDropdownList');
        if (!list) return;
        
        if (list.classList.contains('hidden')) {
            showMoveStorageStallList();
        } else {
            list.classList.add('hidden');
        }
    }

    function showMoveStorageStallList() {
        const list = document.getElementById('mv_stallDropdownList');
        if (!list) return;
        
        list.innerHTML = '';
        
        // FIX: Improved Filter logic for Storage Move
        // Must filter out stalls that are already occupied by ACTIVE STORAGE
        let occupiedStorageStalls = new Set();
        if (typeof globalStorageMap !== 'undefined') {
            // globalStorageMap is updated by fetchData -> getActiveStorageMap
            // So it keys by stallName
            Object.keys(globalStorageMap).forEach(key => occupiedStorageStalls.add(key));
        }

        let hasData = false;
        // Use global stallsData if available
        if (typeof stallsData !== 'undefined' && stallsData.length > 0) {
            stallsData.forEach(s => {
                if (s.type === 'ทางเดิน' || s.type === 'อื่นๆ') return;
                
                // Exclude if already has storage
                if (occupiedStorageStalls.has(s.name)) return;

                hasData = true;
                const div = document.createElement('div');
                div.className = 'mv-move-option px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b last:border-0 flex justify-between';
                div.dataset.search = s.name.toLowerCase();
                div.innerHTML = `<span class="font-bold pointer-events-none">${s.name}</span>`;
                div.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    selectMoveStorageStall(s.name);
                };
                list.appendChild(div);
            });
        } 
        
        if (!hasData) {
            list.innerHTML = '<div class="p-2 text-center text-xs text-gray-400">ไม่พบข้อมูลล็อคว่าง</div>';
        }
        
        list.classList.remove('hidden');
    }

    function filterMoveStorageStalls() {
        const input = document.getElementById('mv_stallSearch');
        const filter = input.value.toLowerCase();
        const list = document.getElementById('mv_stallDropdownList');
        
        if (list.classList.contains('hidden')) {
             showMoveStorageStallList();
        } else {
             // Ensure list is populated if user types before clicking arrow
             if(list.children.length === 0) showMoveStorageStallList();
        }
        
        const options = list.querySelectorAll('.mv-move-option');
        options.forEach(div => {
            if (div.dataset.search.includes(filter)) {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
            }
        });
        
        // Clear hidden value if user is typing
        document.getElementById('mv_target_stall').value = "";
        validateMoveInput();
    }

    function selectMoveStorageStall(name) {
        document.getElementById('mv_stallSearch').value = name;
        document.getElementById('mv_target_stall').value = name;
        document.getElementById('mv_stallDropdownList').classList.add('hidden');
        validateMoveInput();
    }
    
    // Hide dropdown on outside click
    document.addEventListener('click', function(e) {
        const wrapper = document.getElementById('storageMoveModal');
        const input = document.getElementById('mv_stallSearch');
        const list = document.getElementById('mv_stallDropdownList');
        const toggleBtn = wrapper ? wrapper.querySelector('button[onclick*="toggleMoveStorageDropdown"]') : null;
        
        if (wrapper && !wrapper.classList.contains('hidden')) {
             if (e.target !== input && e.target !== list && e.target !== toggleBtn && !toggleBtn?.contains(e.target) && list && !list.contains(e.target)) {
                 list.classList.add('hidden');
             }
        }
    });

    function validateMoveInput() {
        const val = document.getElementById('mv_target_stall').value.trim();
        const btn = document.getElementById('btn_confirm_move_stall');
        if(val.length > 0) {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    function submitMoveStorage() {
        const target = document.getElementById('mv_target_stall').value.trim();
        if(target) submitMoveToLocation(target.toUpperCase());
    }

    function submitMoveToLocation(newLocation) {
        const id = document.getElementById('mv_storage_id').value;
        const currentLoc = document.getElementById('mv_current_location').value;
        
        if (newLocation === currentLoc) {
            alert("ปลายทางต้องไม่ซ้ำกับตำแหน่งปัจจุบัน");
            return;
        }

        showLoader();
        google.script.run
            .withSuccessHandler((res) => {
                hideLoader();
                if(res.success) {
                    closeStorageMoveModal();
                    showAlert(`ย้ายไปยัง ${newLocation} เรียบร้อย`, "สำเร็จ", false);
                    fetchStorageList(); 
                    fetchData(true); 
                } else {
                    showAlert(res.message, "ข้อผิดพลาด", true);
                }
            })
            .withFailureHandler(err => {
                hideLoader();
                showAlert("Error: " + err, "ข้อผิดพลาด", true);
            })
            .moveStorageLocation(id, newLocation);
    }

    function handleReturnStorage(id, stallName) {
        showConfirm(`ยืนยันการคืนของล็อค ${stallName}? \nรายการจะถูกเปลี่ยนสถานะเป็น "คืนแล้ว"`, "ยืนยันคืนของ", () => {
            showLoader();
            google.script.run
                .withSuccessHandler((res) => {
                    hideLoader();
                    if(res.success) {
                        showAlert(res.message, "สำเร็จ", false);
                        fetchStorageList(); 
                        fetchData(true); 
                    } else {
                        showAlert(res.message, "ข้อผิดพลาด", true);
                    }
                })
                .withFailureHandler(err => {
                    hideLoader();
                    showAlert("Error: " + err, "ข้อผิดพลาด", true);
                })
                .completeStorageItem(id);
        });
    }

    function handleReprintStorage(id) {
        const item = storageDataCache.find(x => x.id === id);
        if (!item) return;

        const officerName = currentAdmin ? (currentAdmin.employeeId || currentAdmin.name) : "System";

        const ticketData = {
            ownerName: item.ownerName,
            stallName: item.stallName,
            amount: "160", 
            note: item.note,
            method: "Reprint", 
            officer: officerName,
            timestampStr: formatTicketDateTime(new Date()), 
            startDateStr: formatThaiDateFull(item.startDate),
            endDateStr: formatThaiDateFull(item.endDate)
        };
        
        printStorageTicket(ticketData);
    }
</script><!-- Storage Management Modal -->
<div id="storageManagementModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[80]">
    <div class="bg-white w-11/12 md:max-w-5xl mx-auto rounded-xl shadow-lg z-50 overflow-hidden flex flex-col h-[85vh] animate-bounce-in">
        
        <!-- Header -->
        <div class="bg-gradient-to-r from-orange-500 to-red-500 px-4 py-3 flex justify-between items-center shrink-0">
            <h3 class="font-bold text-lg text-white flex items-center gap-2">
                <i class="fa-solid fa-boxes-packing"></i> จัดการฝากของ
            </h3>
            <button onclick="closeStorageManagementModal()" class="text-white hover:text-orange-200 transition">
                <i class="fa-solid fa-times text-lg"></i>
            </button>
        </div>

        <!-- Toolbar -->
        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex flex-col md:flex-row gap-3 justify-between items-center">
            <div class="flex gap-2 w-full md:w-auto">
                <div class="relative w-full md:w-64">
                    <input type="text" id="store_searchInput" onkeyup="filterStorageList()" placeholder="ค้นหา (ล็อค, ชื่อ, โทร)..." class="w-full pl-8 pr-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-400">
                    <i class="fa-solid fa-search absolute left-2.5 top-2.5 text-gray-400 text-xs"></i>
                </div>
                <select id="store_filterStatus" onchange="filterStorageList()" class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-orange-400 bg-white">
                    <option value="Active">กำลังฝาก (Active)</option>
                    <option value="Completed">คืนแล้ว (History)</option>
                    <option value="All">ทั้งหมด</option>
                </select>
            </div>
            <button onclick="fetchStorageList()" class="text-gray-500 hover:text-orange-600 transition text-sm">
                <i class="fa-solid fa-sync-alt mr-1"></i> รีเฟรช
            </button>
        </div>

        <!-- Content Table -->
        <div class="flex-1 overflow-auto p-0 relative bg-white">
            <div id="store_loading" class="hidden absolute inset-0 bg-white bg-opacity-90 z-10 flex flex-col items-center justify-center text-gray-400">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-2 text-orange-500"></i>
                <p class="text-sm">กำลังโหลดข้อมูล...</p>
            </div>

            <table class="w-full text-sm text-left whitespace-nowrap">
                <thead class="bg-gray-100 text-gray-600 font-bold sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="px-4 py-3 text-center w-10">#</th>
                        <th class="px-4 py-3">วันที่เริ่ม - สิ้นสุด</th>
                        <th class="px-4 py-3">ล็อค</th>
                        <th class="px-4 py-3">เจ้าของ</th>
                        <th class="px-4 py-3">โน้ต</th>
                        <th class="px-4 py-3 text-center">สถานะ</th>
                        <th class="px-4 py-3 text-center">จัดการ</th>
                    </tr>
                </thead>
                <tbody id="store_tableBody" class="divide-y divide-gray-100">
                    <!-- Rows will be injected here -->
                </tbody>
            </table>
            
            <div id="store_noData" class="hidden flex flex-col items-center justify-center py-12 text-gray-400">
                <i class="fa-solid fa-box-open text-4xl mb-2 opacity-30"></i>
                <p>ไม่พบข้อมูล</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 px-4 py-2 border-t border-gray-200 text-xs text-gray-500 flex justify-between items-center">
            <div id="store_countInfo">รายการทั้งหมด: 0</div>
            <button onclick="closeStorageManagementModal()" class="px-4 py-2 bg-white border border-gray-300 rounded hover:bg-gray-100 font-bold text-gray-600">ปิด</button>
        </div>
    </div>
</div>