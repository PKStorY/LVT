<script>
    /**
     * Scripts_UI
     * Centralized UI Helpers (Modal Animation, Alerts, Loaders)
     */

    function showLoader() {
        const overlay = document.getElementById('processOverlay');
        if (overlay) overlay.classList.remove('hidden');
    }

    function hideLoader() {
        const overlay = document.getElementById('processOverlay');
        if (overlay) overlay.classList.add('hidden');
    }

    // --- SHARED MODAL LOGIC (Animation & Scroll Lock) ---
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        
        // Remove 'pointer-events-none' and 'opacity-0' if present (from previous hides)
        modal.classList.remove('pointer-events-none', 'opacity-0');
        
        // Add active class to body to lock scroll
        if (!document.body.classList.contains('modal-active')) {
            // Calculate scrollbar width to prevent layout shift
            const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
            if (scrollbarWidth > 0) {
                document.body.style.paddingRight = `${scrollbarWidth}px`;
            }
            document.body.classList.add('modal-active');
        }
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        
        // Add fade out effect class if you have one, or just hide
        modal.classList.add('opacity-0'); 
        modal.classList.add('pointer-events-none');
        
        setTimeout(() => {
            modal.style.display = 'none';
            modal.classList.add('hidden'); // Ensure hidden class is added back
            
            // Check if any other modals are open
            const activeModals = document.querySelectorAll('.modal:not(.hidden):not(.opacity-0)');
            if (activeModals.length === 0) {
                document.body.classList.remove('modal-active');
                document.body.style.paddingRight = '';
            }
        }, 300); // Match transition duration
    }

    // --- CUSTOM ALERT ---
    function showAlert(message, title = "แจ้งเตือน", isError = false) {
        const modal = document.getElementById('customAlertModal');
        const iconEl = document.getElementById('alertIcon');
        const titleEl = document.getElementById('alertTitle');
        const msgEl = document.getElementById('alertMessage');

        if (isError) {
            iconEl.innerHTML = '<i class="fa-solid fa-circle-xmark text-red-500 animate-pulse"></i>';
            titleEl.className = "text-xl font-bold text-red-600 mb-2 font-kanit";
        } else {
            iconEl.innerHTML = '<i class="fa-solid fa-circle-check text-green-500 animate-bounce"></i>';
            titleEl.className = "text-xl font-bold text-green-600 mb-2 font-kanit";
        }
        
        titleEl.innerText = title;
        msgEl.innerText = message;
        
        showModal('customAlertModal');
    }

    function closeAlert() {
        hideModal('customAlertModal');
    }

    // --- CUSTOM CONFIRM ---
    function showConfirm(message, title, onConfirm) {
        const modal = document.getElementById('customConfirmModal');
        document.getElementById('confirmTitle').innerText = title;
        document.getElementById('confirmMessage').innerText = message;
        
        const btnConfirm = document.getElementById('btnConfirmAction');
        const newBtn = btnConfirm.cloneNode(true);
        btnConfirm.parentNode.replaceChild(newBtn, btnConfirm);
        
        newBtn.onclick = function() {
            hideModal('customConfirmModal');
            if (onConfirm) onConfirm();
        };

        showModal('customConfirmModal');
    }
    
    // --- BOOKING SUCCESS MODAL ---
    // FIX: Using showModal/hideModal to ensure visibility
    function showBookingSuccess(message, showPrint, onPrint, onPreview, onClose) {
        const modal = document.getElementById('bookingSuccessModal');
        const msgEl = document.getElementById('successMessage');
        const btnPrint = document.getElementById('btnSuccessPrint');
        const btnPreview = document.getElementById('btnSuccessPreview');
        const btnClose = document.getElementById('btnSuccessClose');
        
        if (!modal) return;

        msgEl.innerText = message || "บันทึกข้อมูลเรียบร้อยแล้ว";

        // Logic: ถ้าจ่ายแล้ว (isPaid) ให้โชว์ปุ่มพิมพ์/ดูตัวอย่าง
        if (showPrint) {
            btnPrint.classList.remove('hidden');
            
            // Clone to remove old listeners
            const newBtnPrint = btnPrint.cloneNode(true);
            btnPrint.parentNode.replaceChild(newBtnPrint, btnPrint);
            
            newBtnPrint.onclick = function() {
                // Keep modal open or hide based on workflow? Usually print keeps it open or hides it.
                // Let's hide it to print clean
                // hideModal('bookingSuccessModal'); -> Handled by callback
                if (onPrint) onPrint();
            };

            // Preview Action Logic
            if (onPreview) {
                btnPreview.classList.remove('hidden');
                const newBtnPreview = btnPreview.cloneNode(true);
                btnPreview.parentNode.replaceChild(newBtnPreview, btnPreview);
                
                newBtnPreview.onclick = function() {
                     // hideModal('bookingSuccessModal'); -> Handled by callback
                     if (onPreview) onPreview();
                };
            } else {
                btnPreview.classList.add('hidden');
            }

        } else {
            btnPrint.classList.add('hidden');
            btnPreview.classList.add('hidden');
        }
        
        const newBtnClose = btnClose.cloneNode(true);
        btnClose.parentNode.replaceChild(newBtnClose, btnClose);
        
        newBtnClose.onclick = function() {
            hideModal('bookingSuccessModal');
            if (onClose) onClose();
        };
        
        // FIX: Ensure this calls the shared showModal to handle opacity classes
        showModal('bookingSuccessModal');
    }

    // --- GUEST MODAL LOGIC (New) ---
    function openGuestModal(stall, booking) {
        document.getElementById('g_stallName').innerText = stall.name;
        const prodEl = document.getElementById('g_product');
        const statusEl = document.getElementById('g_status_badge');
        
        if (booking) {
            prodEl.innerText = booking.product || "ไม่ระบุสินค้า";
            if (booking.status === 'ชำระแล้ว' || booking.status === 'ไม่ว่าง') {
                 statusEl.innerHTML = '<span class="inline-block px-3 py-1 rounded border-2 border-[#8B0000] text-[#8B0000] bg-[#FFCCCC] font-bold text-sm shadow-sm transform -rotate-2">ไม่ว่าง (Full)</span>';
            } else {
                 statusEl.innerHTML = '<span class="inline-block px-3 py-1 rounded border-2 border-[#D2691E] text-[#D2691E] bg-[#FFE4C4] font-bold text-sm shadow-sm">จองแล้ว (Reserved)</span>';
            }
        } else {
            prodEl.innerText = "-";
             statusEl.innerHTML = '<span class="inline-block px-3 py-1 rounded border-2 border-[#228B22] text-[#228B22] bg-[#F0FFF0] font-bold text-sm shadow-sm transform rotate-2">ว่าง (Available)</span>';
        }
        
        showModal('guestModal');
    }

    function closeGuestModal() {
        hideModal('guestModal');
    }
</script>