<script>
    /**
     * Scripts_UI
     * Centralized UI Helpers (Modal, Alerts, Loaders) & Map Rendering
     * Update: Adjusted Monthly Product Text Color (White -> Pink-900) for better visibility
     */

    // ==========================================
    // PART 1: UI HELPERS (Common Functions)
    // ==========================================

    function showLoader() {
        const overlay = document.getElementById('processOverlay');
        if (overlay) overlay.classList.remove('hidden');
    }

    function hideLoader() {
        const overlay = document.getElementById('processOverlay');
        if (overlay) overlay.classList.add('hidden');
    }

    // --- SHARED MODAL LOGIC ---
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        modal.classList.remove('pointer-events-none', 'opacity-0');
        
        if (!document.body.classList.contains('modal-active')) {
            const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
            if (scrollbarWidth > 0) {
                document.body.style.paddingRight = `${scrollbarWidth}px`;
            }
            document.body.classList.add('modal-active');
        }
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        
        modal.classList.add('opacity-0'); 
        modal.classList.add('pointer-events-none');
        
        setTimeout(() => {
            modal.style.display = 'none';
            modal.classList.add('hidden');
            
            const activeModals = document.querySelectorAll('.modal:not(.hidden):not(.opacity-0)');
            if (activeModals.length === 0) {
                document.body.classList.remove('modal-active');
                document.body.style.paddingRight = '';
            }
        }, 300);
    }

    // --- ALERTS & CONFIRMS ---
    function showAlert(message, title = "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", isError = false) {
        const modal = document.getElementById('customAlertModal');
        const iconEl = document.getElementById('alertIcon');
        const titleEl = document.getElementById('alertTitle');
        const msgEl = document.getElementById('alertMessage');

        if (isError) {
            iconEl.innerHTML = '<i class="fa-solid fa-circle-xmark text-red-500 animate-pulse"></i>';
            titleEl.className = "text-xl font-bold text-red-600 mb-2 font-kanit";
        } else {
            iconEl.innerHTML = '<i class="fa-solid fa-circle-check text-green-500 animate-bounce"></i>';
            titleEl.className = "text-xl font-bold text-green-600 mb-2 font-kanit";
        }
        
        titleEl.innerText = title;
        msgEl.innerText = message;
        showModal('customAlertModal');
    }

    function closeAlert() {
        hideModal('customAlertModal');
    }

    function showConfirm(message, title, onConfirm) {
        const modal = document.getElementById('customConfirmModal');
        document.getElementById('confirmTitle').innerText = title;
        document.getElementById('confirmMessage').innerText = message;
        
        const btnConfirm = document.getElementById('btnConfirmAction');
        const newBtn = btnConfirm.cloneNode(true);
        btnConfirm.parentNode.replaceChild(newBtn, btnConfirm);
        
        newBtn.onclick = function() {
            hideModal('customConfirmModal');
            if (onConfirm) onConfirm();
        };

        showModal('customConfirmModal');
    }
    
    function showBookingSuccess(message, showPrint, onPrint, onPreview, onClose) {
        const modal = document.getElementById('bookingSuccessModal');
        const msgEl = document.getElementById('successMessage');
        const btnPrint = document.getElementById('btnSuccessPrint');
        const btnPreview = document.getElementById('btnSuccessPreview');
        const btnClose = document.getElementById('btnSuccessClose');
        
        if (!modal) return;

        msgEl.innerText = message || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";

        if (showPrint) {
            btnPrint.classList.remove('hidden');
            const newBtnPrint = btnPrint.cloneNode(true);
            btnPrint.parentNode.replaceChild(newBtnPrint, btnPrint);
            newBtnPrint.onclick = function() { if (onPrint) onPrint(); };

            if (onPreview) {
                btnPreview.classList.remove('hidden');
                const newBtnPreview = btnPreview.cloneNode(true);
                btnPreview.parentNode.replaceChild(newBtnPreview, btnPreview);
                newBtnPreview.onclick = function() { if (onPreview) onPreview(); };
            } else {
                btnPreview.classList.add('hidden');
            }
        } else {
            btnPrint.classList.add('hidden');
            btnPreview.classList.add('hidden');
        }
        
        const newBtnClose = btnClose.cloneNode(true);
        btnClose.parentNode.replaceChild(newBtnClose, btnClose);
        newBtnClose.onclick = function() {
            hideModal('bookingSuccessModal');
            if (onClose) onClose();
        };
        
        showModal('bookingSuccessModal');
    }

    function openGuestModal(stall, booking) {
        document.getElementById('g_stallName').innerText = stall.name;
        const prodEl = document.getElementById('g_product');
        const statusEl = document.getElementById('g_status_badge');
        
        if (booking) {
            prodEl.innerText = booking.product || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
            if (booking.status === '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' || booking.status === '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á') {
                 statusEl.innerHTML = '<span class="inline-block px-3 py-1 rounded border-2 border-[#8B0000] text-[#8B0000] bg-[#FFCCCC] font-bold text-sm shadow-sm transform -rotate-2">‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á (Full)</span>';
            } else {
                 statusEl.innerHTML = '<span class="inline-block px-3 py-1 rounded border-2 border-[#D2691E] text-[#D2691E] bg-[#FFE4C4] font-bold text-sm shadow-sm">‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (Reserved)</span>';
            }
        } else {
            prodEl.innerText = "-";
             statusEl.innerHTML = '<span class="inline-block px-3 py-1 rounded border-2 border-[#228B22] text-[#228B22] bg-[#F0FFF0] font-bold text-sm shadow-sm transform rotate-2">‡∏ß‡πà‡∏≤‡∏á (Available)</span>';
        }
        showModal('guestModal');
    }

    function closeGuestModal() {
        hideModal('guestModal');
    }

    // ==========================================
    // PART 2: MAP RENDERING LOGIC (ORIGINAL STRUCTURE)
    // ==========================================

    function renderGrid(data) {
        // Update Globals
        stallsData = (data && data.stalls) ? data.stalls : [];
        bookingsData = (data && data.bookings) ? data.bookings : [];
        
        if (data.storageMap) {
            if(typeof globalStorageMap !== 'undefined') globalStorageMap = data.storageMap;
            else window.globalStorageMap = data.storageMap;
        }

        const grid = document.getElementById('grid-container');
        if (!grid) return;
        
        // Clear loader
        const loader = grid.querySelector('.grid-loading-overlay');
        if(loader) loader.remove();

        if (!stallsData || stallsData.length === 0) { 
            grid.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏±‡∏á‡∏ï‡∏•‡∏≤‡∏î</div>'; 
            return; 
        }
        
        // Calculate Grid Dimensions
        let maxRow = 26; 
        let maxCol = 20; 
        stallsData.forEach(s => {
            const r = parseInt(s.row) || 0;
            const c = parseInt(s.col) || 0;
            if (r > maxRow) maxRow = r;
            if (c > maxCol) maxCol = c;
        });

        grid.style.gridTemplateColumns = `repeat(${maxCol}, minmax(45px, 1fr))`;

        // Prepare Map
        const bookingMap = {};
        bookingsData.forEach(b => bookingMap[b.stallName] = b);
        
        // Date Logic
        const [y, m, d] = selectedDate.split('-').map(Number);
        const dateObj = new Date(y, m - 1, d);
        const dayOfWeek = dateObj.getDay();
        let priceKey = 'priceWed';
        if (dayOfWeek === 6) priceKey = 'priceSat';
        if (dayOfWeek === 0) priceKey = 'priceSun';
        
        const fragment = document.createDocumentFragment();

        // Render Loop
        for (let r=1; r<=maxRow; r++) {
            for (let c=1; c<=maxCol; c++) {
                const cellId = `stall-${r}-${c}`;
                const stall = stallsData.find(s => parseInt(s.row) == r && parseInt(s.col) == c);
                
                // Smart DOM Reuse
                let cell = document.getElementById(cellId);
                let isUpdate = (cell !== null);

                if (!cell) {
                    cell = document.createElement('div'); 
                    cell.id = cellId; 
                    cell.style.gridRow = r; 
                    cell.style.gridColumn = c; 
                }
                
                // Base Style
                let baseClassName = 'stall-box rounded text-center shadow-sm relative';
                let finalClassName = baseClassName;
                let contentHtml = "";
                
                if (stall) {
                    const booking = bookingMap[stall.name];
                    const storage = (typeof globalStorageMap !== 'undefined') ? globalStorageMap[stall.name] : null;
                    const price = stall[priceKey];
                    cell.dataset.name = stall.name;
                    
                    contentHtml = `<span class="text-sm font-bold leading-none">${stall.name}</span>`;
                    let bgClass = "bg-gray-200";
                    let forcedPurple = false;
                    
                    // Regular Monthly Logic
                    const isRegularMonthly = (booking && booking.type === "‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" && booking.note && booking.note.includes("[‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥]"));

                    // Forced Purple for Real Monthly
                    if (booking && booking.type === "‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" && booking.product && booking.product.trim() !== "" && !isRegularMonthly) { 
                        bgClass = "bg-monthly"; 
                        // [MODIFIED] Change text-white to text-pink-900 (Dark Purple/Pink) for better visibility
                        contentHtml += `<div class="text-[10px] mt-0.5 truncate px-1 w-full bg-white bg-opacity-20 rounded font-normal text-pink-900 font-bold">${booking.product}</div>`; 
                        forcedPurple = true; 
                        // Icon for Monthly
                        contentHtml += `<div class="absolute -top-1 -right-1 text-white bg-purple-600 rounded-full w-4 h-4 flex items-center justify-center shadow-sm text-[8px] z-20"><i class="fa-solid fa-crown"></i></div>`;
                    }
                    
                    if (!forcedPurple) {
                        if (stall.type === "‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô") { bgClass = "bg-walkway"; contentHtml = ""; }
                        else if (stall.type === "‡∏≠‡∏∑‡πà‡∏ô‡πÜ") { bgClass = "bg-other"; contentHtml = ""; }
                        else if (stall.type === "‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô") { bgClass = "bg-monthly"; contentHtml += `<div class="text-[10px] mt-0.5 text-white">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>`; } 
                        else {
                            const isFood = stall.type.includes("‡∏≠‡∏≤‡∏´‡∏≤‡∏£");
                            if (booking) {
                                if (booking.status === "‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß" || booking.status === "‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á") { 
                                    // Paid / Full
                                    bgClass = isFood ? "bg-food-occupied" : "bg-cloth-occupied"; 
                                    contentHtml += `<div class="text-[10px] mt-0.5 truncate px-1 w-full bg-white bg-opacity-20 rounded font-normal">${booking.product}</div>`; 
                                } else { 
                                    // Unpaid -> Show Product Name
                                    bgClass = isFood ? "bg-food-unpaid" : "bg-cloth-unpaid"; 
                                    const displayText = booking.product || booking.bookerName || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
                                    contentHtml += `<div class="text-[10px] mt-0.5 font-normal truncate w-full px-0.5">${displayText}</div>`; 
                                    
                                    // Warning Icon (Top-Right)
                                    contentHtml += `<div class="absolute -top-1 -right-1 text-red-600 bg-white rounded-full w-4 h-4 flex items-center justify-center shadow-sm text-[10px] z-20 border border-red-200 animate-pulse"><i class="fa-solid fa-exclamation"></i></div>`;
                                }
                            } else { 
                                // Free
                                bgClass = isFood ? "bg-food-free" : "bg-cloth-free"; 
                                contentHtml += `<div class="text-[10px] mt-0.5 font-normal">${price || '-'}.-</div>`; 
                            }
                        }
                    }
                    
                    // Storage Icon (Top-Left)
                    if (storage) {
                        contentHtml += `<div class="absolute -top-1 -left-1 bg-white rounded-full p-0.5 shadow border border-gray-300 z-20 text-[10px] cursor-help h-4 w-4 flex items-center justify-center" title="‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á: ${storage.ownerName}">üì¶</div>`;
                    }

                    finalClassName = `${baseClassName} ${bgClass}`;
                    
                    if (stall.type !== "‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô" && stall.type !== "‡∏≠‡∏∑‡πà‡∏ô‡πÜ") { 
                        finalClassName += ' clickable'; 
                        cell.onclick = () => {
                            if(typeof handleStallClick === 'function') handleStallClick(stall, booking);
                        };
                    } else { 
                        finalClassName += ' non-clickable'; 
                        cell.onclick = null; 
                    }
                    
                    cell.style.visibility = 'visible';
                } else { 
                    cell.style.visibility = 'hidden'; 
                }
                
                if (cell.className !== finalClassName) cell.className = finalClassName;
                if (cell.innerHTML !== contentHtml) cell.innerHTML = contentHtml;

                if (!isUpdate) {
                    fragment.appendChild(cell);
                }
            }
        }

        if (fragment.childElementCount > 0) {
            grid.appendChild(fragment);
        }
    }

    function showGridLoading() {
        const container = document.getElementById('grid-container');
        if(container) {
            container.innerHTML = `
                <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 bg-gray-100/50 z-10">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-2 text-blue-500"></i>
                    <p class="animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏±‡∏á‡∏ï‡∏•‡∏≤‡∏î...</p>
                </div>
            `;
        }
    }
</script>