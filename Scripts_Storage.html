<script>
    /**
     * Scripts_Storage
     * จัดการการทำงานของระบบฝากของ Client Side
     * FIX: handleReprintStorage now fetches actual payment amount instead of hardcoded "160"
     * FIX: Use Employee ID for Officer field in Ticket (Consistent across all print actions)
     * FIX: Targeted button replacement in checkStorageConflict to prevent UI layout issues
     * FIX: Use showModal() in checkStorageConflict to ensure modal is visible (remove opacity-0)
     * Update: Adjusted showBookingSuccess call for new signature
     */

    let globalStorageMap = {}; 

    function openStorageModal(stallName, prefillOwner = "", bookingId = "") {
        document.getElementById('storageForm').reset();
        document.getElementById('st_stallName').value = stallName;
        document.getElementById('st_bookingId').value = bookingId; 
        document.getElementById('st_displayStall').innerText = stallName;
        
        document.getElementById('st_ownerName').value = prefillOwner;
        
        document.getElementById('st_amount').value = "160";
        document.getElementById('st_payNow').checked = true;
        toggleStoragePayment();
        
        const bookingModal = document.getElementById('bookingModal');
        if(bookingModal) {
            bookingModal.style.display = 'none'; 
            bookingModal.classList.add('pointer-events-none'); 
        }
        
        showModal('storageModal');
    }

    function closeStorageModal() {
        hideModal('storageModal');
        
        const bookingModal = document.getElementById('bookingModal');
        if(bookingModal) {
            bookingModal.classList.remove('hidden'); 
            bookingModal.style.display = 'none'; 
            bookingModal.classList.add('pointer-events-none');
            bookingModal.classList.add('opacity-0');
        }
    }

    function toggleStoragePayment() {
        const isPay = document.getElementById('st_payNow').checked;
        const box = document.getElementById('st_paymentMethodBox');
        if (isPay) {
            box.classList.remove('opacity-50', 'pointer-events-none');
        } else {
            box.classList.add('opacity-50', 'pointer-events-none');
        }
    }

    function submitStorage(e) {
        e.preventDefault();
        
        const payNow = document.getElementById('st_payNow').checked;
        const methodEl = document.querySelector('input[name="st_method"]:checked');
        const amount = parseFloat(document.getElementById('st_amount').value || 0);
        
        const formData = {
            stallName: document.getElementById('st_stallName').value,
            bookingId: document.getElementById('st_bookingId').value, 
            ownerName: document.getElementById('st_ownerName').value,
            phone: document.getElementById('st_phone').value,
            note: document.getElementById('st_note').value,
            amount: amount,
            payNow: payNow,
            method: methodEl ? methodEl.value : 'Cash'
        };

        if(!formData.ownerName) {
            showAlert("กรุณาระบุชื่อเจ้าของ", "ข้อมูลไม่ครบ", true);
            return;
        }

        showLoader();
        google.script.run
            .withSuccessHandler((res) => {
                hideLoader();
                if(res.success) {
                    closeStorageModal(); 
                    
                    const dailyStorageInput = document.getElementById('m_storageFee_daily');
                    const dailyTotalEl = document.getElementById('m_totalPrice_daily');
                    
                    if (dailyStorageInput && dailyTotalEl) {
                        dailyStorageInput.value = amount; 
                        document.getElementById('m_storageFee').value = amount; 
                        if(typeof calcTotalDaily === 'function') calcTotalDaily();
                    }
                    
                    showBookingSuccess(
                        "บันทึกการฝากของเรียบร้อย",
                        payNow, 
                        () => { // On Print
                            const now = new Date();
                            const nextWeek = new Date(now);
                            nextWeek.setDate(now.getDate() + 6);
                            
                            const officerID = currentAdmin ? (currentAdmin.employeeId || currentAdmin.name) : "System";
                            
                            const ticketData = {
                                ownerName: formData.ownerName,
                                stallName: formData.stallName,
                                amount: formData.amount,
                                note: formData.note,
                                method: formData.method,
                                officer: officerID,
                                timestampStr: formatTicketDateTime(now),
                                startDateStr: formatThaiDateFull(now.toISOString().split('T')[0]),
                                endDateStr: formatThaiDateFull(nextWeek.toISOString().split('T')[0])
                            };
                            
                            printStorageTicket(ticketData); 
                            
                            hideModal('bookingSuccessModal');
                            setTimeout(() => fetchData(true), 500); 
                        },
                        null, 
                        () => fetchData(true) 
                    );
                    
                    fetchData(true); 
                } else {
                    showAlert(res.message, "ข้อผิดพลาด", true);
                }
            })
            .withFailureHandler((err) => {
                hideLoader();
                showAlert("Error: " + err, "ข้อผิดพลาด", true);
            })
            .saveStorageItem(formData);
    }

    function checkStorageConflict(stallName, onProceed) {
        const storage = globalStorageMap[stallName];
        if (storage) {
            document.getElementById('confirmTitle').innerText = `⚠️ พบของฝากที่ล็อค ${stallName}`;
            document.getElementById('confirmMessage').innerHTML = `
                <div class="text-left bg-orange-50 p-3 rounded border border-orange-200 text-xs mb-2">
                    <div><b>เจ้าของ:</b> ${storage.ownerName}</div>
                    <div><b>โทร:</b> ${storage.phone}</div>
                    <div><b>หมดอายุ:</b> ${formatThaiDateShort(storage.endDate)}</div>
                    <div><b>โน้ต:</b> ${storage.note || "-"}</div>
                </div>
                <p>ต้องการดำเนินการอย่างไร?</p>
            `;
            
            const btnContainer = document.getElementById('confirmBtnContainer');
            if (!btnContainer) {
                 console.error("Confirm Button Container not found");
                 // Fallback if ID not found (should be fixed in HTML, but safety here)
                 return;
            }

            const originalHtml = btnContainer.innerHTML; 
            
            // Inject new custom buttons
            btnContainer.innerHTML = `
                <button id="btnMoveStorage" class="px-3 py-2 bg-purple-600 text-white rounded-xl text-xs font-bold hover:bg-purple-700 shadow-sm flex-1 transform active:scale-95 transition-all">ย้ายไปจุดพัก</button>
                <button id="btnSellToOwner" class="px-3 py-2 bg-green-600 text-white rounded-xl text-xs font-bold hover:bg-green-700 shadow-sm flex-1 transform active:scale-95 transition-all">ขายให้เจ้าของ</button>
                <button id="btnCancelStorage" class="px-3 py-2 bg-gray-100 text-gray-600 rounded-xl text-xs font-bold hover:bg-gray-200 flex-none w-20 transition-colors">ยกเลิก</button>
            `;
            
            // FIX: Use showModal to properly remove opacity/pointer-events classes
            showModal('customConfirmModal');
            
            document.getElementById('btnMoveStorage').onclick = () => {
                hideModal('customConfirmModal');
                moveStorageAction(storage.id, onProceed);
                setTimeout(() => { btnContainer.innerHTML = originalHtml; }, 500);
            };
            
            document.getElementById('btnSellToOwner').onclick = () => {
                hideModal('customConfirmModal');
                if(onProceed) onProceed(storage); 
                setTimeout(() => { btnContainer.innerHTML = originalHtml; }, 500);
            };
            
            document.getElementById('btnCancelStorage').onclick = () => {
                hideModal('customConfirmModal');
                setTimeout(() => { btnContainer.innerHTML = originalHtml; }, 500);
            };
            
        } else {
            if(onProceed) onProceed(null);
        }
    }

    function moveStorageAction(storageId, nextAction) {
        showLoader();
        google.script.run
            .withSuccessHandler((res) => {
                hideLoader();
                if(res.success) {
                    showAlert(res.message, "ย้ายสำเร็จ", false);
                    fetchData(true); 
                    if(nextAction) nextAction(null); 
                } else {
                    showAlert(res.message, "ข้อผิดพลาด", true);
                }
            })
            .moveStorageToHolding(storageId);
    }

    function handleReprintStorage(id) {
        const item = storageDataCache.find(x => x.id === id);
        if (!item) return;

        showLoader();
        
        google.script.run.withSuccessHandler((res) => {
            hideLoader();
            
            let amountPaid = 0;
            let method = "Cash"; 
            
            if (res.success && res.data && res.data.length > 0) {
                res.data.forEach(p => amountPaid += parseFloat(p.amount || 0));
                method = res.data[0].method; 
            } else {
                amountPaid = 160; 
            }

            const officerID = currentAdmin ? (currentAdmin.employeeId || currentAdmin.name) : "System";

            const ticketData = {
                ownerName: item.ownerName,
                stallName: item.stallName,
                amount: amountPaid.toString(), 
                note: item.note,
                method: method, 
                officer: officerID,
                timestampStr: formatTicketDateTime(new Date()), 
                startDateStr: formatThaiDateFull(item.startDate),
                endDateStr: formatThaiDateFull(item.endDate)
            };
            
            printStorageTicket(ticketData);

        }).withFailureHandler((err) => {
            hideLoader();
            showAlert("เกิดข้อผิดพลาดในการดึงข้อมูล: " + err, "ข้อผิดพลาด", true);
        }).getPaymentHistory(id); 
    }
</script>